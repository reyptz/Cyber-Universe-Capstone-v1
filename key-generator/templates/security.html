<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sécurité - Ghost Cyber Universe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="/static/css/ghost-dark.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" role="navigation">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-ghost me-2"></i>
                Ghost Cyber Universe
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Accueil</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/generate">Générer</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/security" aria-current="page">Sécurité</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/about">À Propos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/api/docs">API Docs</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content with Tabs for Best Practices -->
    <main class="py-5 bg-ghost-secondary" role="main" id="main-content">
        <div class="container">
            <div class="row">
                <div class="col-lg-10 mx-auto">
                    <header class="text-center mb-5" role="banner">
                        <h1 class="display-4 fw-bold mb-3 text-blackhat-gold  mt-4">
                            <i class="fas fa-shield-alt me-3 text-blackhat-red" aria-hidden="true"></i>
                            Bonnes Pratiques de Sécurité Cryptographique
                        </h1>
                        <p class="lead text-ghost-secondary">
                            Guide actualisé 2025 conforme NIST SP 800-57 et OWASP Crypto Cheat Sheet pour une gestion sécurisée des clés.
                        </p>
                    </header>

                    <!-- Best Practices Tabs -->
                    <div class="card-ghost mb-5" role="tablist" aria-label="Onglets pratiques de sécurité">
                        <ul class="nav nav-tabs nav-tabs-custom border-0 bg-transparent" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active text-ghost-secondary" id="protection-tab" data-bs-toggle="tab" data-bs-target="#protection" type="button" role="tab" aria-controls="protection" aria-selected="true">
                                    <i class="fas fa-lock me-2" aria-hidden="true"></i>Protection Clés
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link text-ghost-secondary" id="generation-tab" data-bs-toggle="tab" data-bs-target="#generation" type="button" role="tab" aria-controls="generation" aria-selected="false">
                                    <i class="fas fa-key me-2" aria-hidden="true"></i>Génération Sécurisée
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link text-ghost-secondary" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit" type="button" role="tab" aria-controls="audit" aria-selected="false">
                                    <i class="fas fa-history me-2" aria-hidden="true"></i>Audit & Monitoring
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link text-ghost-secondary" id="abuse-tab" data-bs-toggle="tab" data-bs-target="#abuse" type="button" role="tab" aria-controls="abuse" aria-selected="false">
                                    <i class="fas fa-shield-alt me-2" aria-hidden="true"></i>Anti-Abus
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content p-4" id="securityTabContent">
                            <div class="tab-pane fade show active" id="protection" role="tabpanel" aria-labelledby="protection-tab" tabindex="0">
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="alert-ghost alert-ghost-info mb-4" role="alert">
                                            <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                                            <strong>Conseil :</strong> Utilisez toujours un HSM pour les clés critiques.
                                        </div>
                                        <ul class="list-cyber" role="list">
                                            <li><i class="fas fa-check text-blackhat-green me-2" aria-hidden="true"></i>Chiffrement AES-256-GCM avec PBKDF2</li>
                                            <li><i class="fas fa-check text-blackhat-green me-2" aria-hidden="true"></i>Stockage HSM/FIPS 140-3</li>
                                            <li><i class="fas fa-check text-blackhat-green me-2" aria-hidden="true"></i>Aucun stockage en clair</li>
                                            <li><i class="fas fa-check text-blackhat-green me-2" aria-hidden="true"></i>Rotation tous les 90 jours</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="progress-ghost mb-3">
                                            <div class="progress-bar bg-blackhat-red" role="progressbar" style="width: 85%; height: 90%;" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100"></div>
                                            <div class="text-ghost-primary d-block mt-1">Niveau de Sécurité Actuel</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="generation" role="tabpanel" aria-labelledby="generation-tab" tabindex="0">
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <ul class="list-cyber" role="list">
                                            <li><i class="fas fa-check text-blackhat-green me-2" aria-hidden="true"></i>CSPRNG /dev/urandom (Linux)</li>
                                            <li><i class="fas fa-check text-blackhat-green me-2" aria-hidden="true"></i>Entropie > 256 bits</li>
                                            <li><i class="fas fa-check text-blackhat-green me-2" aria-hidden="true"></i>Validation FIPS 186-4</li>
                                            <li><i class="fas fa-check text-blackhat-green me-2" aria-hidden="true"></i>Tests de primalité Miller-Rabin</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="code-block-ghost mb-3" role="code" aria-label="Exemple CSPRNG">
                                            <code>import secrets<br/>key = secrets.token_bytes(32)  # 256 bits</code>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="audit" role="tabpanel" aria-labelledby="audit-tab" tabindex="0">
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <ul class="list-cyber" role="list">
                                            <li><i class="fas fa-check text-blackhat-green me-2" aria-hidden="true"></i>Logs JSON structurés ELK Stack</li>
                                            <li><i class="fas fa-check text-blackhat-green me-2" aria-hidden="true"></i>Traçabilité blockchain-like</li>
                                            <li><i class="fas fa-check text-blackhat-green me-2" aria-hidden="true"></i>Alertes anomalies ML</li>
                                            <li><i class="fas fa-check text-blackhat-green me-2" aria-hidden="true"></i>Rapports PDF automatisés</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <button class="btn btn-outline-info w-100" onclick="window.downloadAuditLog()" aria-label="Télécharger le log d'audit">
                                            <i class="fas fa-download me-2" aria-hidden="true"></i>Télécharger Audit Log
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="abuse" role="tabpanel" aria-labelledby="abuse-tab" tabindex="0">
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <ul class="list-cyber" role="list">
                                            <li><i class="fas fa-check text-blackhat-green me-2" aria-hidden="true"></i>Rate limiting Redis (10/min)</li>
                                            <li><i class="fas fa-check text-blackhat-green me-2" aria-hidden="true"></i>Validation OWASP ZAP</li>
                                            <li><i class="fas fa-check text-blackhat-green me-2" aria-hidden="true"></i>Tokens CSRF/JWT</li>
                                            <li><i class="fas fa-check text-blackhat-green me-2" aria-hidden="true"></i>HSTS & CSP headers</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="alert-ghost alert-ghost-warning" role="alert">
                                            <i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>
                                            <strong>Alerte :</strong> Surveillez les IPs suspectes via le dashboard.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommendations with Dynamic Loading and Error Handling -->
                <section class="mb-5" aria-labelledby="recs-heading">
                    <div class="card-ghost" role="region">
                        <div class="card-header bg-gradient-info text-white mt-1 ml-4">
                            <h3 id="recs-heading" class="mb-0">
                                <i class="fas fa-list-check me-2" aria-hidden="true"></i>
                                Recommandations Personnalisées
                            </h3>
                        </div>
                        <div class="card-body p-4">
                            <div id="securityRecommendations" class="row g-3" role="list">
                                <!-- Dynamic content -->
                                <div class="col-12">
                                    <div class="skeleton-loader" aria-live="polite" aria-label="Chargement en cours..."></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Warnings by Key Type with Expandable Sections -->
                <section class="mb-5" aria-labelledby="warnings-heading">
                    <div class="card-ghost" role="region">
                        <div class="card-header bg-gradient-warning text-dark">
                            <h3 id="warnings-heading" class="mb-0">
                                <i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>
                                Avertissements Critiques par Type
                            </h3>
                        </div>
                        <div class="card-body p-4">
                            <div class="accordion" id="warningsAccordion">
                                <div class="accordion-item bg-transparent border-0">
                                    <h4 class="accordion-header" role="tab">
                                        <button class="accordion-button collapsed text-danger fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#privateKeys" aria-expanded="false">
                                            🔐 Clés Privées (RSA/ECC/Ed25519)
                                        </button>
                                    </h4>
                                    <div id="privateKeys" class="accordion-collapse collapse" role="tabpanel">
                                        <div class="accordion-body">
                                            <ul class="list-unstyled small text-danger" role="list">
                                                <li><i class="fas fa-ban me-2" aria-hidden="true"></i>Jamais partager ou exposer</li>
                                                <li><i class="fas fa-key me-2" aria-hidden="true"></i>Mot de passe >20 chars + 2FA</li>
                                                <li><i class="fas fa-folder-lock me-2" aria-hidden="true"></i>Stockage air-gapped</li>
                                                <li><i class="fas fa-rotate me-2" aria-hidden="true"></i>Révocation CRL/OCSP immédiate</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item bg-transparent border-0">
                                    <h4 class="accordion-header" role="tab">
                                        <button class="accordion-button collapsed text-warning fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#bip39" aria-expanded="false">
                                            💰 BIP39 (Wallets Crypto)
                                        </button>
                                    </h4>
                                    <div id="bip39" class="accordion-collapse collapse" role="tabpanel">
                                        <div class="accordion-body">
                                            <ul class="list-unstyled small text-warning fw-bold" role="list">
                                                <li><i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i><strong>SECRET ABSOLU - Perte = Fonds Perdus</strong></li>
                                                <li><i class="fas fa-wifi me-2 text-danger" aria-hidden="true"></i>Ne jamais entrer en ligne</li>
                                                <li><i class="fas fa-download me-2" aria-hidden="true"></i>Imprimer et stocker physique</li>
                                                <li><i class="fas fa-shield-alt me-2" aria-hidden="true"></i>Utiliser hardware wallet</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item bg-transparent border-0">
                                    <h4 class="accordion-header" role="tab">
                                        <button class="accordion-button collapsed text-info fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#tls" aria-expanded="false">
                                            🔒 Certificats TLS/SSL
                                        </button>
                                    </h4>
                                    <div id="tls" class="accordion-collapse collapse" role="tabpanel">
                                        <div class="accordion-body">
                                            <ul class="list-unstyled small text-info" role="list">
                                                <li><i class="fas fa-calendar-check me-2" aria-hidden="true"></i>Vérifier expiration automatisée</li>
                                                <li><i class="fas fa-sync-alt me-2" aria-hidden="true"></i>Rotation HSM intégrée</li>
                                                <li><i class="fas fa-eye me-2" aria-hidden="true"></i>Surveillance Let's Encrypt</li>
                                                <li><i class="fas fa-thumbs-up me-2" aria-hidden="true"></i>CA racines de confiance uniquement</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item bg-transparent border-0">
                                    <h4 class="accordion-header" role="tab">
                                        <button class="accordion-button collapsed text-success fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#ssh" aria-expanded="false">
                                            🔑 Clés SSH/Accès
                                        </button>
                                    </h4>
                                    <div id="ssh" class="accordion-collapse collapse" role="tabpanel">
                                        <div class="accordion-body">
                                            <ul class="list-unstyled small text-success" role="list">
                                                <li><i class="fas fa-file me-2" aria-hidden="true"></i>~/.ssh/authorized_keys sécurisé</li>
                                                <li><i class="fas fa-lock me-2" aria-hidden="true"></i>Passphrase + YubiKey</li>
                                                <li><i class="fas fa-times me-2 text-danger" aria-hidden="true"></i>Désactiver password auth</li>
                                                <li><i class="fas fa-star me-2" aria-hidden="true"></i>Préférer Ed25519 (rapide)</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Security Report with Real-time Updates -->
                <section class="mb-5" aria-labelledby="report-heading">
                    <div class="card-ghost" role="region">
                        <div class="card-header bg-gradient-success text-white d-flex justify-content-between align-items-center">
                            <h3 id="report-heading" class="mb-0">
                                <i class="fas fa-chart-line me-2" aria-hidden="true"></i>
                                Tableau de Bord Sécurité Temps Réel
                            </h3>
                            <button class="btn btn-outline-light btn-sm" onclick="loadSecurityReport()" aria-label="Actualiser les données">
                                <i class="fas fa-sync-alt" aria-hidden="true"></i> Actualiser
                            </button>
                        </div>
                        <div class="card-body p-4">
                            <div id="securityReport" class="row g-3" aria-live="polite" aria-label="Rapport de sécurité">
                                <div class="col-md-3 text-center">
                                    <div class="skeleton-loader h4"></div>
                                    <small class="text-ghost-muted">Requêtes Totales</small>
                                </div>
                                <div class="col-md-3 text-center">
                                    <div class="skeleton-loader h4"></div>
                                    <small class="text-ghost-muted">Succès</small>
                                </div>
                                <div class="col-md-3 text-center">
                                    <div class="skeleton-loader h4"></div>
                                    <small class="text-ghost-muted">Échecs</small>
                                </div>
                                <div class="col-md-3 text-center">
                                    <div class="skeleton-loader h4"></div>
                                    <small class="text-ghost-muted">Taux Succès</small>
                                </div>
                            </div>
                            <hr class="my-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-gradient">Types de Clés (24h)</h6>
                                    <canvas id="keyTypesChart" class="skeleton-loader" style="height: 200px;"></canvas>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-gradient">Métriques Clés</h6>
                                    <ul class="list-unstyled small" role="list">
                                        <li class="skeleton-loader mb-1"></li>
                                        <li class="skeleton-loader mb-1"></li>
                                        <li class="skeleton-loader mb-1"></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="py-4 text-center" style="background: var(--bg-primary); border-top: 1px solid var(--border-primary);">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h5 class="text-gradient mb-2">
                        <i class="fas fa-ghost me-2"></i>Ghost Cyber Universe
                    </h5>
                    <p class="text-ghost-secondary mb-0">
                        Protection cryptographique avancée.
                    </p>
                </div>
                <div class="col-lg-6 text-lg-end">
                    <p class="text-ghost-secondary mb-0">
                        <i class="fas fa-shield-alt me-2"></i>
                        Sécurisé • Conforme • Open Source
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="/static/js/cyber-animations.js" defer></script>
    <script>
        // Enhanced Dynamic Loading with Error Handling and Skeleton Loaders
        async function loadSecurityRecommendations() {
            const container = document.getElementById('securityRecommendations');
            try {
                container.innerHTML = ''; // Clear skeletons
                const response = await fetch('/api/security-recommendations', { 
                    headers: { 'Accept': 'application/json' } 
                });
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                
                data.recommendations.forEach((rec, index) => {
                    const col = document.createElement('div');
                    col.className = 'col-md-6';
                    col.innerHTML = `
                        <div class="alert-ghost ${index % 2 === 0 ? 'alert-ghost-info' : 'alert-ghost-success'} interactive-element" role="alert">
                            <i class="fas fa-lightbulb me-2" aria-hidden="true"></i>
                            <strong>${rec.title}:</strong> ${rec.description}
                        </div>
                    `;
                    container.appendChild(col);
                });
            } catch (error) {
                console.error('Recommandations error:', error);
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert-ghost alert-ghost-danger" role="alert">
                            <i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>
                            Erreur de chargement. Vérifiez votre connexion.
                        </div>
                    </div>
                `;
            }
        }

        let reportChart;
        async function loadSecurityReport() {
            const container = document.getElementById('securityReport');
            try {
                const response = await fetch('/api/security-report');
                if (!response.ok) throw new Error('Report Error');
                const data = await response.json();
                
                // Update metrics
                const metrics = container.querySelectorAll('.col-md-3');
                metrics[0].innerHTML = `<h4 class="text-blackhat-red">${data.total_requests.toLocaleString()}</h4><small class="text-ghost-muted">Requêtes Totales</small>`;
                metrics[1].innerHTML = `<h4 class="text-blackhat-green">${data.successful_requests.toLocaleString()}</h4><small class="text-ghost-muted">Succès</small>`;
                metrics[2].innerHTML = `<h4 class="text-blackhat-gold">${data.failed_requests.toLocaleString()}</h4><small class="text-ghost-muted">Échecs</small>`;
                metrics[3].innerHTML = `<h4 class="text-blackhat-purple">${data.success_rate.toFixed(1)}%</h4><small class="text-ghost-muted">Taux de Succès</small>`;
                
                // Key types chart
                const canvas = document.getElementById('keyTypesChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                if (reportChart) reportChart.destroy();
                reportChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(data.key_types_generated),
                        datasets: [{
                            data: Object.values(data.key_types_generated),
                            backgroundColor: ['#ff0000', '#8b0000', '#b8860b', '#006400', '#4b0082']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } },
                        animation: { duration: 1000 }
                    }
                });
                
                // Metrics list
                const metricsList = container.parentElement.querySelector('.col-md-6 ul');
                metricsList.innerHTML = `
                    <li><i class="fas fa-users me-2 text-blackhat-blue"></i>IPs Uniques: ${data.unique_ip_addresses}</li>
                    <li><i class="fas fa-tachometer-alt me-2 text-blackhat-green"></i>Limits Actifs: ${data.rate_limits_active}</li>
                    <li><i class="fas fa-exclamation-triangle me-2 text-blackhat-gold"></i>Avertissements: ${data.security_warnings_count}</li>
                `;
                
                // Announce update
                container.setAttribute('aria-live', 'polite');
            } catch (error) {
                console.error('Report error:', error);
                container.innerHTML = `
                    <div class="alert-ghost alert-ghost-danger text-center" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Impossible de charger le rapport. Réessayez.
                    </div>
                `;
            }
        }

        // Global download function
        window.downloadAuditLog = function() {
            // Simulate download
            const link = document.createElement('a');
            link.href = '/api/audit-log/download';
            link.download = 'audit-log.json';
            link.click();
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            loadSecurityRecommendations();
            loadSecurityReport();
            // Refresh report every 30s
            setInterval(loadSecurityReport, 30000);
        });
    </script>
</body>
</html>